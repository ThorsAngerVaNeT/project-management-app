<form nz-form class="content-form" [formGroup]="taskAddForm" *ngIf="userEntities$ | async as userEntities">
  <nz-form-item>
    <nz-form-label [nzSm]="7" [nzXs]="24" nzRequired nzFor="title" i18n="@@TaskTitle">Title</nz-form-label>
    <nz-form-control [nzSm]="17" [nzXs]="24" [nzErrorTip]="titleErrorTip">
      <input nz-input id="title" formControlName="title" />
      <ng-template #titleErrorTip>
        <ng-container *ngIf="title?.hasError('required')" i18n="@@TaskTitleRequiredErrorTip"
          >Please provide a title</ng-container
        >
        <ng-container
          *ngIf="title?.hasError('maxlength') || title?.hasError('minlength')"
          i18n="@@TaskTitleMinlengthErrorTip"
          >Title should be 2-40 characters long</ng-container
        >
      </ng-template>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label [nzSm]="7" [nzXs]="24" nzRequired nzFor="description" i18n="@@TaskDescription"
      >Description</nz-form-label
    >
    <nz-form-control [nzSm]="17" [nzXs]="24" [nzErrorTip]="descriptionErrorTip">
      <textarea nz-input rows="2" formControlName="description"></textarea>
      <ng-template #descriptionErrorTip>
        <ng-container *ngIf="description?.hasError('required')" i18n="@@TaskDescriptionRequiredErrorTip"
          >Please provide a description</ng-container
        >
        <ng-container *ngIf="description?.hasError('maxlength')" i18n="@@TaskDescriptionMaxlengthErrorTip"
          >Description should be no more than 255 characters long</ng-container
        >
      </ng-template>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label [nzSm]="7" [nzXs]="24" nzRequired nzFor="responsible" i18n="@@TaskResponsible"
      >Responsible</nz-form-label
    >
    <nz-form-control [nzSm]="17" [nzXs]="24" [nzErrorTip]="responsibleErrorTip">
      <nz-select
        nzMode="default"
        nzPlaceHolder="Please select a responsible person"
        i18n-nzPlaceHolder="@@CreateTaskResponsiblePlaceHolder"
        formControlName="responsible"
        (ngModelChange)="addResponsibleToParticipants($event)"
      >
        <nz-option *ngFor="let user of users" nzLabel="{{ user.name }}" nzValue="{{ user._id }}"></nz-option>
      </nz-select>

      <ng-template #responsibleErrorTip>
        <ng-container *ngIf="responsible?.hasError('required')" i18n="@@TaskResponsibleRequiredErrorTip"
          >Please provide a responsible (task owner)</ng-container
        >
      </ng-template>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label [nzSm]="7" [nzXs]="24" nzRequired nzFor="participants" i18n="@@CreateTaskParticipants"
      >Participants</nz-form-label
    >
    <nz-form-control [nzSm]="17" [nzXs]="24" [nzErrorTip]="participantsErrorTip">
      <nz-select
        nzMode="multiple"
        nzPlaceHolder="Please select team members"
        i18n-nzPlaceHolder="@@CreateTaskParticipantsPlaceHolder"
        formControlName="participants"
      >
        <nz-option
          nzLabel="{{ responsibleToParticipants.name }}"
          nzValue="{{ responsibleToParticipants._id }}"
          nzHide
          nzDisabled
        ></nz-option>
        <nz-option
          *ngFor="let user of users"
          nzLabel="{{ user.name }}"
          nzValue="{{ user._id }}"
          [nzDisabled]="user._id === responsibleToParticipants._id"
        ></nz-option>
      </nz-select>
      <ng-template #participantsErrorTip>
        <ng-container *ngIf="participants?.hasError('required')" i18n="@@TaskParticipantsRequiredErrorTip"
          >Please provide the participants</ng-container
        >
      </ng-template>
    </nz-form-control>
  </nz-form-item>

  <nz-divider nzText="Task Checklist" i18n-nzText="@@CreateTaskChecklist"></nz-divider>

  <nz-form-item>
    <ng-container *ngIf="(pointsLoading$ | async) === false; else loadingSpinner">
      <app-point-item *ngFor="let point of points$ | async as points" [point]="point"></app-point-item>
    </ng-container>
    <ng-template #loadingSpinner>
      <nz-spin nzSimple></nz-spin>
    </ng-template>
  </nz-form-item>

  <app-point-add [point]="point"></app-point-add>

  <ng-template [nzModalFooter]>
    <button nz-button (click)="handleCancel()" i18n="@@CreateTaskCancelText">Cancel</button>
    <button nz-button nzType="primary" (click)="handleOk()" i18n="@@CreateTaskOkText">Save</button>
  </ng-template>
</form>
